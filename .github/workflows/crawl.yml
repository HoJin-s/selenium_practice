name: ğŸ•’ Scheduled Crawler ğŸ•’

on:
  schedule:
    - cron: "30 21 * * *" # ì˜¤ì „ 6:30 (KST)
    - cron: "30 7 * * *" # ì˜¤í›„ 4:30 (KST)
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥ : GitHub Actions â†’ Schedule Crawler â†’ Run workflow ëˆŒëŸ¬ì„œ ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
    inputs:
      should_fail:
        description: "ê°•ì œë¡œ ì‹¤íŒ¨ì‹œí‚¬ê¹Œìš”?"
        required: true
        default: "ì•„ë‹ˆì˜¤"
        type: choice
        options:
          - "ì•„ë‹ˆì˜¤"
          - "ë„¤. ê°•ì œë¡œ ì‹¤íŒ¨ì‹œì¼œì£¼ì„¸ìš”"

jobs:
  crawl:
    runs-on: ubuntu-latest

    steps:
      - name: âœ”ï¸ Checkout repository
        uses: actions/checkout@v3

      - name: âš™ï¸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: âŒ Fail intentionally if requested
        if: ${{ github.event.inputs.should_fail == 'ë„¤. ê°•ì œë¡œ ì‹¤íŒ¨ì‹œì¼œì£¼ì„¸ìš”' }}
        run: |
          echo "ì˜ë„ì ìœ¼ë¡œ ì‹¤íŒ¨ì‹œí‚µë‹ˆë‹¤."
          exit 1

      - name: ğŸ§± Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: ğŸŒ Setup Chrome
        run: |
          sudo apt update
          sudo apt install -y wget unzip
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt install -y ./google-chrome-stable_current_amd64.deb

      - name: ğŸ•’ Print current time (UTC & KST)
        run: |
          echo "UTC : $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "KST : $(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S')"

      - name: ğŸ’¤ Wake up Render Server
        run: |
          curl --silent https://hojin-news-server.onrender.com
          sleep 10

      - name: âš¡ Run crawler
        env:
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
        run: |
          cd backend
          python selenium_practice/parser.py || exit 1
